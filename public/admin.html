<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理画面</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f9f9f9; }
    .container { max-width: 1200px; margin: 0 auto; }
    .section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px;}
    h1, h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
    th { background-color: #f2f2f2; }
    .btn { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
    .delete-btn { background: #dc3545; color: white; }
    .edit-btn { background: #ffc107; color: black; margin-right: 5px;}
    .save-btn { background: #28a745; color: white; margin-right: 5px; }
    .cancel-btn { background: #6c757d; color: white; }
    td input[type="text"], td input[type="number"] { width: 90%; padding: 8px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; }
    .download-btn-admin { display: inline-block; background-color: #17a2b8; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: flex-end; margin-top: 15px; }
    .form-grid input { width: 100%; padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;}
    .form-grid button { background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-size: 1em;}
    .color-picker { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
    .color-box { width: 30px; height: 30px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
    .color-box.selected { border-color: #007bff; }
    .color-swatch { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ccc; }
    td ul { margin: 0; padding-left: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>管理画面</h1>

    <div class="section">
      <h2>会計履歴</h2>
      <div id="bulk-delete-section" style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; margin-bottom: 15px; border-radius: 5px;">
        <h4>期間指定で一括削除</h4>
        <label for="start-date">開始日時:</label> <input type="datetime-local" id="start-date">
        <label for="end-date">終了日時:</label> <input type="datetime-local" id="end-date">
        <button id="bulk-delete-btn" class="btn delete-btn" style="width: auto; margin-left: 10px;">この範囲の履歴を削除</button>
      </div>
      <table>
        <thead>
          <tr><th>会計ID</th><th>日時</th><th>合計金額</th><th>操作</th></tr>
        </thead>
        <tbody id="history-body"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>商品管理</h2>
      <table>
        <thead>
          <tr><th>商品名</th><th>価格</th><th>色</th><th>操作</th></tr>
        </thead>
        <tbody id="product-list-body"></tbody>
      </table>
      <form id="add-product-form">
        <div class="form-grid">
          <div><label for="product-name">商品名</label><input type="text" id="product-name" required></div>
          <div><label for="product-price">価格（円）</label><input type="number" id="product-price" required></div>
          <button type="submit">追加</button>
        </div>
        <div style="margin-top: 15px;"><label>色選択</label><div id="color-picker" class="color-picker"></div></div>
      </form>
    </div>
    
    <div class="section">
        <h2>全売上データ</h2>
        <a href="/api/sales/csv" class="download-btn-admin">売上データをダウンロード (CSV)</a>
    </div>
  </div>

  <div id="edit-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 8px;">
        <h3>会計内容の変更 <span id="edit-sale-id"></span></h3>
        <div id="edit-item-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <select id="add-product-select" style="flex-grow: 1; padding: 8px;"></select>
          <button id="add-item-to-sale-btn">商品を追加</button>
        </div>
        <hr>
        <button id="save-changes-btn">この内容で保存</button>
        <button onclick="document.getElementById('edit-modal').style.display='none'">キャンセル</button>
    </div>
  </div>

  <script>
    const historyBody = document.getElementById('history-body');
    const productListBody = document.getElementById('product-list-body');
    const addProductForm = document.getElementById('add-product-form');
    const colorPicker = document.getElementById('color-picker');

    const colors = ['#ff9e9e','#ffa8d3','#c68eff', '#9999ff', '#9eceff', '#a3ffff', '#9eff9e', '#ffff89', '#ffd1a3'];
    let selectedColor = colors[0];
    let latestSaleId = null;
    let allProducts = [];

    function createColorPicker() {
      colorPicker.innerHTML = '';
      colors.forEach((color, index) => {
        const box = document.createElement('div');
        box.className = 'color-box';
        box.style.backgroundColor = color;
        if (index === 0) box.classList.add('selected');
        box.addEventListener('click', () => {
          document.querySelector('.color-box.selected').classList.remove('selected');
          box.classList.add('selected');
          selectedColor = color;
        });
        colorPicker.appendChild(box);
      });
    }

    async function fetchSalesHistory(forceRerender = false) {
      const response = await fetch('/api/sales/history');
      const sales = await response.json();
      if (!forceRerender && sales.length > 0 && sales[0].id === latestSaleId) return;
      if (sales.length > 0) latestSaleId = sales[0].id;
      historyBody.innerHTML = '';
      sales.forEach(sale => {
        const mainRow = document.createElement('tr');
        mainRow.id = `sale-row-${sale.id}`;
        mainRow.style.cursor = 'pointer';
        mainRow.innerHTML = `
            <td>#${sale.id} <span class="accordion-arrow">▾</span></td>
            <td>${new Date(sale.createdAt).toLocaleString('ja-JP')}</td>
            <td>${sale.finalTotal} 円</td>
            <td><button class="btn edit-btn" data-id="${sale.id}">変更</button><button class="btn delete-btn" data-id="${sale.id}">削除</button></td>`;
        const detailRow = document.createElement('tr');
        detailRow.id = `sale-detail-${sale.id}`;
        detailRow.style.display = 'none';
        const itemCounts = sale.items.reduce((acc, item) => {
            acc[item.name] = { price: item.price, count: (acc[item.name] ? acc[item.name].count : 0) + 1 };
            return acc;
        }, {});
        let detailsHtml = '<ul>';
        for (const name in itemCounts) {
            const item = itemCounts[name];
            detailsHtml += `<li>・${name}: ¥${item.price} x ${item.count} = ¥${item.price * item.count}</li>`;
        }
        detailsHtml += '</ul>';
        const detailCell = document.createElement('td');
        detailCell.colSpan = 4;
        detailCell.innerHTML = detailsHtml;
        detailRow.appendChild(detailCell);
        historyBody.appendChild(mainRow);
        historyBody.appendChild(detailRow);
        mainRow.addEventListener('click', (event) => {
            if (event.target.closest('button')) return;
            const isHidden = detailRow.style.display === 'none';
            detailRow.style.display = isHidden ? '' : 'none';
            mainRow.querySelector('.accordion-arrow').textContent = isHidden ? '▴' : '▾';
        });
      });
    }
    
    historyBody.addEventListener('click', async function(event) {
        const button = event.target.closest('button');
        if (!button) return;
        const saleId = button.dataset.id;
        if (button.classList.contains('delete-btn')) {
            deleteSale(saleId);
        } else if (button.classList.contains('edit-btn')) {
            const response = await fetch('/api/sales/history');
            const sales = await response.json();
            const saleData = sales.find(s => s.id == saleId);
            openEditModal(saleData);
        }
    });

    async function deleteSale(id) {
      if (!confirm(`会計ID #${id} を本当に削除しますか？\nこの操作は元に戻せません。`)) return;
      const response = await fetch(`/api/sales/${id}`, { method: 'DELETE' });
      if (response.ok) {
        fetchSalesHistory(true);
      } else {
        alert('削除に失敗しました。');
      }
    }

    async function openEditModal(saleData) {
        // (会計履歴の編集機能は変更なし)
        const modal = document.getElementById('edit-modal');
        const itemListDiv = document.getElementById('edit-item-list');
        const saleIdSpan = document.getElementById('edit-sale-id');
        const saveBtn = document.getElementById('save-changes-btn');
        const addProductSelect = document.getElementById('add-product-select');
        const addItemBtn = document.getElementById('add-item-to-sale-btn');
        saleIdSpan.textContent = `(#${saleData.id})`;
        addProductSelect.innerHTML = allProducts.map(p => `<option value="${p.id}">${p.name} (${p.price}円)</option>`).join('');
        let currentItems = [...saleData.items];
        function renderEditList() {
            itemListDiv.innerHTML = '';
            const itemCounts = currentItems.reduce((acc, item) => { acc[item.id] = (acc[item.id] || 0) + 1; return acc; }, {});
            const uniqueItems = [...new Map(currentItems.map(item => [item.id, item])).values()];
            uniqueItems.forEach(item => {
                const count = itemCounts[item.id];
                const itemEl = document.createElement('div');
                itemEl.style = 'display: flex; justify-content: space-between; align-items: center; padding: 5px 0;';
                itemEl.innerHTML = `<span>${item.name} (¥${item.price})</span><div><button class="quantity-btn" data-id="${item.id}" data-action="decrease">-</button><span style="display: inline-block; width: 30px; text-align: center;">${count}</span><button class="quantity-btn" data-id="${item.id}" data-action="increase">+</button><button class="delete-item-btn" data-id="${item.id}" style="margin-left: 10px; color: red; border: none; background: none; cursor: pointer; font-weight: bold;">×</button></div>`;
                itemListDiv.appendChild(itemEl);
            });
        }
        renderEditList();
        const newAddItemBtn = addItemBtn.cloneNode(true);
        addItemBtn.parentNode.replaceChild(newAddItemBtn, addItemBtn);
        newAddItemBtn.onclick = () => {
            const selectedProductId = parseInt(addProductSelect.value, 10);
            const productToAdd = allProducts.find(p => p.id === selectedProductId);
            if(productToAdd) { currentItems.push(productToAdd); renderEditList(); }
        };
        itemListDiv.onclick = function(event) {
            const button = event.target.closest('button');
            if (!button) return;
            const productId = parseInt(button.dataset.id, 10);
            if (button.classList.contains('quantity-btn')) {
                const action = button.dataset.action;
                if (action === 'increase') {
                    const productToAdd = allProducts.find(p => p.id === productId);
                    if (productToAdd) currentItems.push(productToAdd);
                } else if (action === 'decrease') {
                    const itemIndex = currentItems.findIndex(item => item.id === productId);
                    if (itemIndex > -1) currentItems.splice(itemIndex, 1);
                }
            } else if (button.classList.contains('delete-item-btn')) {
                currentItems = currentItems.filter(item => item.id !== productId);
            }
            renderEditList();
        };
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        newSaveBtn.onclick = async function() {
            const response = await fetch(`/api/sales/${saleData.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: currentItems }) });
            if (response.ok) {
                alert('会計情報を更新しました。');
                document.getElementById('edit-modal').style.display = 'none';
                fetchSalesHistory(true);
            } else { alert(`更新に失敗しました。`); }
        };
        modal.style.display = 'flex';
    }

    // ★★★ ここから商品管理のロジックを大幅に変更 ★★★
    async function fetchProducts() {
      const response = await fetch('/api/products');
      allProducts = await response.json();
      productListBody.innerHTML = '';
      allProducts.forEach(product => {
        const row = document.createElement('tr');
        row.id = `product-row-${product.id}`;
        // 通常時の表示行を生成
        renderProductRow(row, product);
        productListBody.appendChild(row);
      });
    }

    // 通常時の商品行をレンダリングする関数
    function renderProductRow(row, product) {
        row.innerHTML = `
            <td>${product.name}</td>
            <td>${product.price} 円</td>
            <td><div class="color-swatch" style="background-color: ${product.color};"></div></td>
            <td>
                <button class="btn edit-btn" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">編集</button>
                <button class="btn delete-btn" data-id="${product.id}">削除</button>
            </td>
        `;
    }

    // 編集時の商品行をレンダリングする関数
    function renderEditRow(row, product) {
        row.innerHTML = `
            <td><input type="text" value="${product.name}" id="edit-name-${product.id}"></td>
            <td><input type="number" value="${product.price}" id="edit-price-${product.id}"></td>
            <td><div class="color-swatch" style="background-color: ${product.color};"></div></td>
            <td>
                <button class="btn save-btn" data-id="${product.id}">保存</button>
                <button class="btn cancel-btn" data-id="${product.id}">キャンセル</button>
            </td>
        `;
    }

    productListBody.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;

        const id = parseInt(button.dataset.id, 10);
        const row = document.getElementById(`product-row-${id}`);
        const product = allProducts.find(p => p.id === id);

        if (button.classList.contains('edit-btn')) {
            renderEditRow(row, product);
        }
        else if (button.classList.contains('cancel-btn')) {
            renderProductRow(row, product);
        }
        else if (button.classList.contains('save-btn')) {
            const newName = document.getElementById(`edit-name-${id}`).value;
            const newPrice = document.getElementById(`edit-price-${id}`).value;
            
            if (!newName || !newPrice || newPrice < 0) {
                alert("商品名と正しい価格を入力してください。");
                return;
            }

            const response = await fetch(`/api/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, price: newPrice })
            });

            if (response.ok) {
                await fetchProducts(); // 成功したらリストを再描画
            } else {
                alert('商品の更新に失敗しました。');
            }
        }
        else if (button.classList.contains('delete-btn')) {
            if (confirm(`商品「${product.name}」を本当に削除しますか？`)) {
                const response = await fetch(`/api/products/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await fetchProducts();
                } else {
                    alert('削除に失敗しました。');
                }
            }
        }
    });

    addProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('product-name');
      const priceInput = document.getElementById('product-price');
      const response = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: nameInput.value, price: priceInput.value, color: selectedColor })
      });
      if (response.ok) {
        fetchProducts();
        nameInput.value = '';
        priceInput.value = '';
      } else { alert('商品の追加に失敗しました。'); }
    });

    document.getElementById('bulk-delete-btn').addEventListener('click', async () => {
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        if (!start || !end) return alert('開始日時と終了日時を両方選択してください。');
        if (confirm(`本当に ${new Date(start).toLocaleString()} から ${new Date(end).toLocaleString()} までの履歴をすべて削除しますか？\nこの操作は元に戻せません。`)) {
            try {
                const response = await fetch(`/api/sales?start=${start}&end=${end}`, { method: 'DELETE' });
                const result = await response.json();
                alert(result.message);
                fetchSalesHistory(true);
            } catch (err) { alert('エラーが発生しました。'); }
        }
    });

    async function initializeAdminPage() {
      createColorPicker();
      await fetchProducts();
      await fetchSalesHistory(true);
      setInterval(() => fetchSalesHistory(false), 5000);
    }

    initializeAdminPage();
  </script>
</body>
</html>